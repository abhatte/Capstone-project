# Capstone project milestone report
*******
Ashwini Bhatte
2 August 2017

##Introduction
*******
**Insulin dependent diabetes mellitus** (IDDM) also known as **Type 1 diabetes** is a chronic illness characterised by the body’s inability to produce insulin due to the autoimmune destruction of the beta cells in the pancreas.

Patients with type 1 diabetes mellitus (DM) require lifelong insulin therapy. Most require 2 or more injections of insulin daily, with doses adjusted on the basis of self-monitoring of blood glucose levels. Long-term management requires a multidisciplinary approach that includes physicians, nurses, dieticians, and selected specialists.

Outpatient management of IDDM relies principally on three interventions: diet, exercise and exogenous insulin. Proper treatment requires careful consideration of all three interventions.

Patients with diabetes face a lifelong challenge to achieve and maintain blood glucose levels as close to the normal range as possible.

**Hyperglycemia**: BG > 200 mg/dl

**Average BG**: 150 mg/dl

**Hypoglycemia**: BG < 80 mg/dl

_But it is desirable to keep 90% of all BG measurements < 200 mg/dl._

With appropriate glycemic control, the risk of both microvascular and neuropathic complications is decreased markedly.
In addition to being a lifelong disease, the treatment of DM is multifaceted making it necessary to take many variables  into account.

The goal of this project is to extract understandable patterns and associations from data through data visualisation.

## Dataset
*****
The dataset consists og 70 .tsv files and a data code and a domain description file.
Each file out of the 70 different files represent the data for a single DM patient.
Each file contain 4 attributes: Date, Time, Code, Value

### Date
The dataset covers several weeks' to months' worth of outpatient care on 70 patients.

The date is in MM-DD-YYYY format.

### Time
Diabetes patient records were obtained from two sources: an automatic electronic recording device and paper records. The automatic device had an internal clock to timestamp events, whereas the paper records only provided "logical time" slots (breakfast, lunch, dinner, bedtime). For paper records, fixed times were assigned to breakfast (08:00), lunch (12:00), dinner (18:00), and bedtime (22:00).

The time is in XX:YY format.

### Code
The Code field is deciphered as follows:

33 = Regular insulin dose

34 = NPH insulin dose

35 = UltraLente insulin dose

48 = Unspecified blood glucose measurement

57 = Unspecified blood glucose measurement

58 = Pre-breakfast blood glucose measurement

59 = Post-breakfast blood glucose measurement

60 = Pre-lunch blood glucose measurement

61 = Post-lunch blood glucose measurement

62 = Pre-supper blood glucose measurement

63 = Post-supper blood glucose measurement

64 = Pre-snack blood glucose measurement

65 = Hypoglycemic symptoms

66 = Typical meal ingestion

67 = More-than-usual meal ingestion

68 = Less-than-usual meal ingestion

69 = Typical exercise activity

70 = More-than-usual exercise activity

71 = Less-than-usual exercise activity

72 = Unspecified special event

### Value
This attribute represents a blood glucose (BG) concentration at a particular time after a particular activity (see Code).

BG concentration vary even in individuals with normal pancreatic hormonal function. 

**Normal person BG concentration**

pre-meal: 80-120 mg/dl

post-meal: 80-140 mg/dl

**DM patient BG concentration**

The target range for an individual with diabetes mellitus is very controversial.

So to cut the Gordian knot,

* it would be very desirable to keep 90% of all BG measurements < 200 mg/dl
+ average BG: 150 mg/dl or less

**Hyperglycemia** (BG > 200 mg/dl, over several years) is associated with a poor long-term outcome with the risk of vascular complications.

And **Hypoglycemia** (BG < 80) may have symptoms such as headache, abdominal pain, sweating. Additionally BG < 40 mg/dl may result in neuroglycopenic symptoms such as lethargy, weakness, disorientation, seizures and passing out.  



### file_name
This column has been added, to represents the patient number (1-70)

Below is the overview (head) of the combined dataset

```{r, include=FALSE}
library(readr)
library(dplyr)
library(tidyr)
library(ggplot2)
{master <- data.frame()
for(i in 1:70) {
  num = paste("", i, sep = "")
  if (i < 10) num = paste("0", i, sep = "")
  fname = paste("~/R Projects/diabetes-dataset/Diabetes-Data/data-", num, sep = "")
  temp <- read_delim(fname, col_names = c("date", "time", "code", "bg_conc"), 
   col_types = cols(
    date = col_date(format = "%m-%d-%Y"),
    time = col_time(format = "%R"),
    code = col_integer(),
    bg_conc = col_character()
  ), "\t",
    escape_double = FALSE, trim_ws = TRUE);
  temp <- mutate(temp, file_name = i)
  master <- rbind(master, temp);
}}
```
```{r, echo=FALSE}
head(master)
```

## Data limitations
*****
The main limitation of this dataset is the occurence of Unspecified blood glucose measurement twice in the code feature. Since this is an important information, which can not be rejected; these two codes are treated separately.

Also, it would have been useful to include demographics of a patient such as Age and Sex, to predict how blood glucose concentration varies.

## Data wrangling and cleaning
*****
The diabetes data set from UCI machine learning repository is relatively comprehensive and well put together and did not require any major transformations.

However, since there are 70 different .tsv files for individual patients, they need to be merged in a single data frame. 

Here are the data wrangling steps for diabetes data set

1. Load the required libraries

2. Create "master" data frame 
   + Add variable file_name to represent file number / patient number (01:70)
   + read all 70 files and add column names ("date", "time", "code", "bg_conc")
   + covert observations to a desirable format
   + bind observations from all 70 files to create master data frame
   
```{r, include=FALSE}
library(readr)
library(dplyr)
library(tidyr)
library(ggplot2)
{master <- data.frame()
for(i in 1:70) {
  num = paste("", i, sep = "")
  if (i < 10) num = paste("0", i, sep = "")
  fname = paste("~/R Projects/diabetes-dataset/Diabetes-Data/data-", num, sep = "")
  temp <- read_delim(fname, col_names = c("date", "time", "code", "bg_conc"), 
   col_types = cols(
    date = col_date(format = "%m-%d-%Y"),
    time = col_time(format = "%R"),
    code = col_integer(),
    bg_conc = col_character()
  ), "\t",
    escape_double = FALSE, trim_ws = TRUE);
  temp <- mutate(temp, file_name = i)
  master <- rbind(master, temp);
}}
```

3. create newmaster to clean the data

4. remove "000" & "3A" from bg_conc as they are illogical values

5. newmaster contains code "4", "36, & "56", but since there is no entry of such codes in the data description, these values are removed as well

```{r, echo=TRUE}
library(tidyr)
newmaster <- subset(master, bg_conc != "000" & bg_conc != "3A")
newmaster <- subset(newmaster, code != "4" & code != "36" & code != "56")
```

6. For further EDA, convert newmaster$bg_conc from character to numeric

```{r, echo=TRUE}
newmaster$bg_conc <- as.numeric(newmaster$bg_conc)
```

7. remove NAs from above

```{r, echo=TRUE}
newmaster <- na.omit(newmaster)
```

8. Two hour time bins were created to explore how time attribute affects the BG concentration

```{r, echo=TRUE}
library(dplyr)
newmaster <- newmaster %>%
  mutate(time_grp = gsub("^00:[0-9][0-9]:00|^01:[0-9][0-9]:00", "00-02", x = time))%>%
  mutate(time_grp = gsub("^02:[0-9][0-9]:00|^03:[0-9][0-9]:00", "02-04", x = time_grp))%>%
  mutate(time_grp = gsub("^04:[0-9][0-9]:00|^05:[0-9][0-9]:00", "04-06", x = time_grp))%>%   
  mutate(time_grp = gsub("^06:[0-9][0-9]:00|^07:[0-9][0-9]:00", "06-08", x = time_grp))%>%
  mutate(time_grp = gsub("^08:[0-9][0-9]:00|^09:[0-9][0-9]:00", "08-10", x = time_grp))%>%
  mutate(time_grp = gsub("^10:[0-9][0-9]:00|^11:[0-9][0-9]:00", "10-12", x = time_grp))%>%
  mutate(time_grp = gsub("^12:[0-9][0-9]:00|^13:[0-9][0-9]:00", "12-14", x = time_grp))%>%
  mutate(time_grp = gsub("^14:[0-9][0-9]:00|^15:[0-9][0-9]:00", "14-16", x = time_grp))%>%    
  mutate(time_grp = gsub("^16:[0-9][0-9]:00|^17:[0-9][0-9]:00", "16-18", x = time_grp))%>%
  mutate(time_grp = gsub("^18:[0-9][0-9]:00|^19:[0-9][0-9]:00", "18-20", x = time_grp))%>%
  mutate(time_grp = gsub("^20:[0-9][0-9]:00|^21:[0-9][0-9]:00", "20-22", x = time_grp))%>%
  mutate(time_grp = gsub("^22:[0-9][0-9]:00|^23:[0-9][0-9]:00", "22-24", x = time_grp))
```

From BG concentration measurements, we can derive if the patient is Hypoglycemic, Hyperglycemic or has a blood glucose in average range. The average BG for a diebetic patient is, 150 mg/dl. 

9. But as we have already discussed that it is desirable to keep 90% of all BG measurements < 200 mg/dl. 
Therefore, we will create groups

**Hypoglycemia**: BG < 80 mg/dl

**Average**: BG < 200 mg/dl

**Hyperglycemia**: BG > 200 mg/dl

```{r, echo=TRUE}
newmaster <- newmaster %>%
  mutate(bg_symp = gsub("^([0-9]|[0-7][0-9]|80)$", 
                        "Hypoglycemia", x = bg_conc))%>%
  mutate(bg_symp = gsub("^(8[1-9]|9[0-9]|1[0-9][0-9])$", "Average", x = bg_symp))%>%
  mutate(bg_symp = gsub("^(2[0-9][0-9]|3[0-9][0-9]|4[0-9][0-9]|50[0-1])$", 
                        "Hyperglycemia", x = bg_symp))%>%
  mutate(bg_symp = gsub("^(1.5|2.5|3.5|4.5|6.5|7.5)$", "Hypoglycemia", x = bg_symp))
```

```{r, echo=FALSE}
summary(newmaster)
```

## Exploratory Data analysis
*****
The purpose of the inital exploration was to gauge the relationship between the BG concentration and the associated codes to determine if there are any factors that determines the increase or decrease in BG concentration.

Since bg_conc is the only numeric variable in the data set; it’s distribution was checked but plotting the histogram plot.

```{r, echo=FALSE}
library(ggplot2)
qplot(newmaster$bg_conc,
      geom="histogram",
      binwidth = 5,  
      main = "Histogram for Blood Glucose", 
      xlab = "Blood Glucose",  
      fill=I("black"), 
      col=I("red"), 
      alpha=I(0.2))
```

From Histogram for Blood Glucose we can see that majority of readings for BG concentration are found to be Hypoglycaemic.

Now that we have determined the distribution of BG concentration, the focus of the further data visualisation and exploration will be to deep dive into other variables and determine how they interact with one another.

The following variables will be investigated in this section:

* _Code vs Blood Glucose concentration_

+ _Time vs Blood Glucose concentration_ 

_**Code vs Blood Glucose concentration**_

```{r, echo=FALSE}
library(ggplot2)
ggplot(newmaster, aes(factor(code), bg_conc)) +
  geom_boxplot() +
  labs(x = "Code", y = "BG concentration (mg/dl)") +
  ggtitle("Relation between Code & Blood Glucose concentration", subtitle = "Figure 2")
```

In **Figure 2**, note that there are 3 clear groups of codes.

To gain a better perspective at this, let’s plot the graph of BG concentration vs code by grouping the codes into 3 sub categories.

**1. group 1: code 33 - 35**

This group represent the codes for type of insulin dose

```{r, echo=FALSE}
library(ggplot2)
c1 <- c(33:35)
newmaster1 <- newmaster[newmaster$code %in% c1,]
ggplot(newmaster1, aes(factor(code), bg_conc)) +
  geom_boxplot() +
  labs(x = "Code", y = "BG concentration (mg/dl)") +
  ggtitle("Relation between Insulin dose & Blood Glucose concentration", subtitle = "Figure 3")
```

```{r, echo=FALSE}
summary(newmaster1$bg_conc)
```

From **Figure 3**, we can see that the BG concentation of a patient drops down after taking an exogenous insuline dose.

   Code  |     Type        | Onset of effect | Time of peak action | Effective duration
   ----- | --------------- |---------------- |-------------------- |-------------------
    33   | Regular Insulin |  15-45 minutes  |     1-3 hours       |    4-6 hours
    34   | NPH Insulin     |  1-3 hours      |     4-6 hours       |    10-14 hours
    35   | Ultralente      |  2-5 hours      |  not much of a peak |    24-30 hours
-------

**2. group 2: code 48, 57 - 64**

This group represent the codes which are related to meal (pre or post) of a patient.

```{r, echo=FALSE}
c2 <- c(48, 57:64)
newmaster2 <- newmaster[newmaster$code %in% c2,]
ggplot(newmaster2, aes(factor(code), bg_conc)) +
  geom_boxplot() +
  labs(x = "Code", y = "BG concentration (mg/dl)") +
  ggtitle("Relation between meal & Blood Glucose concentration", subtitle = "Figure 4")
```

```{r, echo=FALSE}
summary(newmaster2$bg_conc)
```

In **Figure 4**, the type of insuline injected will determine the level of BG concentration across various patients.

Note that, in the box plot above, codes 58, 60, 62, 64 represent a pre meal BG concentration and codes 59, 61, 63 represent a post meal BG concentration.

-------

**3. group 3: code 65 - 72**

The codes in this group represent any unusual activities related to meal or exercise and the Hypoglycaemic symptoms.

```{r, echo=FALSE}
c3 <- c(65:72)
newmaster3 <- newmaster[newmaster$code %in% c3,]
ggplot(newmaster3, aes(factor(code), bg_conc)) +
  geom_boxplot() +
  labs(x = "Code", y = "BG concentration (mg/dl)") +
  ggtitle("Relation between exercise & Blood Glucose concentration", subtitle = "Figure 5")
```

```{r, echo=FALSE}
summary(newmaster3$bg_conc)
```

In **figure 5**, we see that all the BG concentration values are 0 mg/ml. Since code 65 represents the Hypoglycemic symptoms, it is normal to have BG concentration value around 0 mg/dl. But, for the remaining code, it is not logical. Hence we assume that these values were supposed to be measured but they are just the place holder for now.

---------

_**Time vs Blood Glucose concentration **_
Since time is a continuous variable, it will be difficult to export the data when time is plotted on x- axis.
Which is why the time intervals of 2 hours (time_grp) were created (See data wrangling). The distribution of BG measurements across various time intervals was explored initially using a simple bar plot.

```{r, echo=FALSE}
library(ggplot2)
ggplot(newmaster, aes(time_grp)) +
 geom_bar() +
 labs(x = "Hours") +
 ggtitle("Histogram for time groups", subtitle = "Figure 6")
```

From **Figure 6**, we can say that most of the BG concentration was measured from 6 - 10, 12 - 14 & from 16 -24.

--------

Now let’s get a clearer view of the relationship between time interval and BG concentration by plotting a box plot.

```{r, echo=FALSE}
ggplot(newmaster, aes(factor(time_grp), bg_conc)) +
  geom_boxplot() +
  labs(x = "Hours", y = "Blood glucose concentration") +
  ggtitle("Relation between time interval & Blood Glucose concentration", subtitle = "Figure 7")
```

From **Figure 7**, we can say that the BG concentration remains lower from 4 - 10 am assuming that these are pre breakfast measurements. 
Similarly, the hypoglycaemia is observed from 16 - 22 assuming they are pre meal measurements.

However, BG concentration rises after a meal i.e from time slot 10 - 16 & 22 - 24.

--------

Now, let's see the distribution of BG measurements in individual time slots

```{r, echo=FALSE}
ggplot(newmaster, aes(factor(time_grp), bg_conc)) +
  geom_point(alpha = 0.1) +
  scale_shape(1, solid = FALSE) +
  geom_jitter(width = 0.1) +
  geom_boxplot(alpha = 0.2) +
  labs(x = "Hours", y = "Blood glucose value") +
  ggtitle("Distribution of blood glucose measurements over 24 hours", subtitle = "Figure 8")
```

**Figure 8**, clearly shows that there were minimum number of measurements taken from 00 - 04 in the night. The maximum number of BG concentration are taken during the day time.

--------

As discussed already, we have categorised BG concentration into 3 sub categories: Hypoglycemia, average BG concentration and Hyperglycemia.

The distribution of these 3 categories is shown below in the Figure 9 by simply plotting the points on time slots. Each point here represents number of Blood glucose measurements by the patients in 24 hours for several weeks or months.

```{r, echo=FALSE}
ggplot(newmaster, aes(factor(time_grp), bg_conc, col = bg_symp)) +
  geom_point() +
  labs(x = "Hours", y = "Blood glucose concentration") +
  ggtitle("Distribution of BG symptoms over 24 hours", subtitle = "Figure 9")
```

----------

In **Figure 10**, lets see the boxplot of symptoms and BG concentration

```{r, echo=FALSE}
newmaster$bg_symp <- factor(newmaster$bg_symp, levels = c("Hypoglycemia", "Average",
                                                          "Hyperglycemia"))
ggplot(newmaster, aes(bg_symp, bg_conc, col = bg_symp)) +
  geom_point() +
  geom_boxplot(alpha = 0.4, width = 4.5) +
  facet_grid(.~ (bg_symp)) +
  labs(x = "Symptoms", y = "Blood glucose concentration, mg/dl") +
  ggtitle("Distribution of BG symptoms", subtitle = "Figure 10")
```

----------
